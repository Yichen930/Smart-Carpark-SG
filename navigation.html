<!DOCTYPE html>
<html class="dark" lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Active Navigation Route - Smart Carpark SG</title>
<script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
<link href="https://fonts.googleapis.com/css2?family=Public+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>
<script id="tailwind-config">
    tailwind.config = {
        darkMode: "class",
        theme: {
            extend: {
                colors: {
                    "primary": "#137fec",
                    "background-light": "#f6f7f8",
                    "background-dark": "#101922",
                    "danger": "#ef4444",
                },
                fontFamily: {
                    "display": ["Public Sans", "sans-serif"]
                },
                borderRadius: {
                    "DEFAULT": "0.25rem",
                    "lg": "0.5rem",
                    "xl": "0.75rem",
                    "full": "9999px"
                },
            },
        },
    }
</script>
<style>
    body {
        font-family: 'Public Sans', sans-serif;
        -webkit-tap-highlight-color: transparent;
    }
    .map-gradient-overlay {
        background: linear-gradient(180deg, rgba(16, 25, 34, 0.8) 0%, rgba(16, 25, 34, 0) 25%, rgba(16, 25, 34, 0) 75%, rgba(16, 25, 34, 0.9) 100%);
    }
    body {
        min-height: max(884px, 100dvh);
    }
</style>
</head>
<body class="bg-background-light dark:bg-background-dark text-white overflow-hidden">
<div class="relative flex h-screen w-full flex-col bg-background-dark overflow-hidden">
<!-- Full Screen Map View -->
<div class="absolute inset-0 z-0">
    <div class="h-full w-full bg-cover bg-center" data-alt="Dark stylized map of Singapore city streets with blue route line" style="background-image: url('https://lh3.googleusercontent.com/aida-public/AB6AXuDV_nvJUcilLMRKtCKBbAiNO3lBVGvtz6R5I6bOPpB6mVieYsZYil4_j8ePlNlKd79lJqGK2iecwgz7uSKPOYyaS076hHM6CIsGmbaJKSjaYfSKQ-1-rZpOzAxfZuK1ZCHHn0n0D5Izw73PtzSrr278aiNZcw6cufE_EDpWfl_o_9E9PqJZuIf_rr4J0wmUsQxvpf7nTTZWkx3D-QtiF4osQtiLmqFNlx5LI-icaDPWRGk26lwdNwxw0CiO8H84wMZH8CBjsb8tz0lE');">
        <!-- Map Overlay Dimmer -->
        <div class="absolute inset-0 bg-black/40 map-gradient-overlay"></div>
    </div>
    <!-- Simulated Active Route Line (CSS Vector) -->
    <svg class="absolute inset-0 w-full h-full pointer-events-none" fill="none" viewbox="0 0 400 800" xmlns="http://www.w3.org/2000/svg">
        <path class="drop-shadow-[0_0_10px_rgba(19,127,236,0.8)]" d="M200 800C200 800 180 600 220 500C260 400 350 350 350 250C350 150 200 100 200 0" stroke="#137fec" stroke-linecap="round" stroke-linejoin="round" stroke-width="12"></path>
        <!-- Current Position Marker -->
        <circle cx="200" cy="700" fill="#137fec" r="10"></circle>
        <circle class="animate-pulse" cx="200" cy="700" r="20" stroke="#137fec" stroke-width="2"></circle>
    </svg>
</div>

<!-- Top Navigation Status Overlay -->
<div class="relative z-10 w-full px-4 pt-12 pb-4">
    <div class="bg-background-dark/90 backdrop-blur-md rounded-xl border border-white/10 p-4 flex items-center justify-between shadow-2xl">
        <div class="flex items-center gap-4">
            <div class="bg-primary/20 p-2 rounded-lg">
                <span class="material-symbols-outlined text-primary text-3xl">navigation</span>
            </div>
            <div>
                <p class="text-xs uppercase tracking-widest text-primary font-bold">Route Status</p>
                <h2 class="text-xl font-extrabold text-white leading-tight">Active Navigation</h2>
            </div>
        </div>
        <div class="text-right">
            <p class="text-xs text-white/50 uppercase tracking-wider">Destination</p>
            <p id="destinationName" class="text-sm font-semibold text-white">Marina Bay Sands P3</p>
        </div>
    </div>
</div>

<!-- Floating Map Controls (Right Side) -->
<div class="relative z-10 flex flex-col items-end gap-3 px-4 mt-auto mb-4">
    <button class="flex size-14 items-center justify-center rounded-xl bg-background-dark/90 backdrop-blur-md border border-white/10 shadow-lg active:scale-95 transition-transform">
        <span class="material-symbols-outlined text-white text-3xl">add</span>
    </button>
    <button class="flex size-14 items-center justify-center rounded-xl bg-background-dark/90 backdrop-blur-md border border-white/10 shadow-lg active:scale-95 transition-transform">
        <span class="material-symbols-outlined text-white text-3xl">remove</span>
    </button>
    <button class="flex size-14 items-center justify-center rounded-xl bg-primary shadow-lg shadow-primary/30 active:scale-95 transition-transform">
        <span class="material-symbols-outlined text-white text-3xl">my_location</span>
    </button>
</div>

<!-- Bottom Dashboard Card -->
<div class="relative z-10 w-full bg-background-dark/95 backdrop-blur-xl border-t border-white/10 px-4 pt-6 pb-10 rounded-t-[2rem] shadow-[0_-10px_40px_rgba(0,0,0,0.5)]">
    <div class="flex gap-4 mb-6">
        <!-- Distance Info -->
        <div class="flex-1 bg-white/5 rounded-2xl p-5 border border-white/5">
            <div class="flex items-center gap-2 mb-1">
                <span class="material-symbols-outlined text-white/60 text-lg">straighten</span>
                <p class="text-white/60 text-sm font-medium uppercase tracking-tight">Distance</p>
            </div>
            <p id="routeDistance" class="text-4xl font-extrabold text-white">1.2 <span class="text-lg font-bold text-white/50">km</span></p>
        </div>
        <!-- Time Info -->
        <div class="flex-1 bg-white/5 rounded-2xl p-5 border border-white/5">
            <div class="flex items-center gap-2 mb-1">
                <span class="material-symbols-outlined text-primary text-lg">schedule</span>
                <p class="text-white/60 text-sm font-medium uppercase tracking-tight">Time</p>
            </div>
            <p id="routeTime" class="text-4xl font-extrabold text-white">5 <span class="text-lg font-bold text-white/50">mins</span></p>
        </div>
    </div>
    <!-- Large Cancel Button for Safety -->
    <button id="cancelRouteBtn" class="w-full h-18 py-5 flex items-center justify-center gap-3 rounded-2xl bg-danger/10 border-2 border-danger/30 text-danger hover:bg-danger hover:text-white transition-all duration-300 active:scale-[0.98]">
        <span class="material-symbols-outlined font-bold">close</span>
        <span class="text-xl font-extrabold uppercase tracking-wider">Cancel Route</span>
    </button>
    <!-- Drag Indicator for iOS feel -->
    <div class="absolute bottom-2 left-1/2 -translate-x-1/2 w-12 h-1.5 bg-white/20 rounded-full"></div>
</div>

<!-- Re-recommendation Modal (hidden by default) -->
<div id="reRecommendationModal" class="hidden fixed inset-0 z-50 bg-black/60 backdrop-blur-sm">
    <div class="absolute bottom-0 left-0 right-0 bg-background-light dark:bg-background-dark rounded-t-xl shadow-[0_-10px_30px_rgba(0,0,0,0.5)] border-t border-white/10 max-h-[80vh] overflow-y-auto">
        <div class="flex h-6 w-full items-center justify-center pt-2">
            <div class="h-1.5 w-12 rounded-full bg-gray-300 dark:bg-gray-700"></div>
        </div>
        <div class="px-6 pb-2 pt-2">
            <div class="flex items-center gap-2 text-red-500 mb-1">
                <span class="material-symbols-outlined text-[20px] font-bold">error</span>
                <span class="text-xs font-bold uppercase tracking-wider text-red-500">Unavailable</span>
            </div>
            <h3 class="text-gray-900 dark:text-white tracking-tight text-2xl font-bold leading-tight">Carpark No Longer Available</h3>
            <p class="text-gray-600 dark:text-gray-400 text-sm font-normal leading-normal mt-1">
                The selected carpark is now full. We found alternative options nearby.
            </p>
        </div>
        <div id="alternativeList" class="px-4 py-4 space-y-3">
            <!-- Alternatives will be populated by JS -->
        </div>
        <div class="px-4 pb-10 pt-2 flex flex-col gap-3">
            <button id="switchRouteBtn" class="flex h-14 w-full items-center justify-center rounded-xl bg-primary text-white font-bold text-lg shadow-lg shadow-primary/30 active:scale-[0.98] transition-transform">
                <span class="material-symbols-outlined mr-2">directions_car</span>
                Switch Route
            </button>
            <button id="ignoreBtn" class="flex h-12 w-full items-center justify-center rounded-xl bg-transparent text-gray-500 dark:text-gray-400 font-semibold text-base hover:bg-gray-100 dark:hover:bg-white/5">
                Ignore & Keep Original
            </button>
        </div>
        <div class="h-2 bg-background-light dark:bg-background-dark"></div>
    </div>
</div>
</div>

<script src="js/app.js"></script>
<script src="js/mockData.js"></script>
<script>
    // Load route data
    const carparkData = JSON.parse(sessionStorage.getItem('selectedCarpark') || '{}');
    const activeRoute = JSON.parse(sessionStorage.getItem('activeRoute') || '{}');
    
    // Store initial availability when navigation starts
    const initialAvailability = carparkData.availableLots || 45;
    let reRecommendationShown = false;
    let availabilityCheckInterval;
    
    // Update destination name
    document.getElementById('destinationName').textContent = carparkData.name || 'Orchard Central Carpark';
    
    // Calculate route distance and time (mock)
    const distance = carparkData.distance || 1.2;
    const estimatedTime = Math.round(distance * 4); // ~4 mins per km
    
    document.getElementById('routeDistance').innerHTML = `${distance.toFixed(1)} <span class="text-lg font-bold text-white/50">km</span>`;
    document.getElementById('routeTime').innerHTML = `${estimatedTime} <span class="text-lg font-bold text-white/50">mins</span>`;
    
    // Cancel route
    document.getElementById('cancelRouteBtn').addEventListener('click', function() {
        if (availabilityCheckInterval) {
            clearInterval(availabilityCheckInterval);
        }
        sessionStorage.removeItem('activeRoute');
        App.navigateTo('results.html');
    });
    
    // Check carpark availability periodically
    // Simulate availability dropping over time
    function checkAvailability() {
        if (reRecommendationShown) {
            return;
        }
        
        // Simulate availability decreasing (mock - in real app this would be API call)
        // After 3-7 seconds, simulate the carpark becoming unavailable
        const elapsed = Date.now() - (activeRoute.startTime || Date.now());
        const checkDelay = 3000 + Math.random() * 4000; // Random between 3-7 seconds
        
        if (elapsed > checkDelay) {
            // Simulate carpark becoming unavailable
            const currentAvailability = 0; // No lots available
            
            if (currentAvailability === 0 && initialAvailability > 0) {
                showReRecommendation();
                reRecommendationShown = true;
                if (availabilityCheckInterval) {
                    clearInterval(availabilityCheckInterval);
                }
            }
        }
    }
    
    // Start checking availability every second
    availabilityCheckInterval = setInterval(checkAvailability, 1000);
    
    // Also check immediately after a short delay (for demo purposes)
    setTimeout(checkAvailability, 3000);
    
    function showReRecommendation() {
        const modal = document.getElementById('reRecommendationModal');
        
        // Find alternatives that are available (have lots > 0)
        const alternatives = mockCarparks
            .filter(cp => cp.id !== carparkData.id && cp.availableLots > 0)
            .slice(0, 2)
            .sort((a, b) => {
                // Sort by recommendation score first, then by distance
                if (Math.abs(b.recommendationScore - a.recommendationScore) > 0.5) {
                    return b.recommendationScore - a.recommendationScore;
                }
                return a.distance - b.distance;
            });
        
        // If no alternatives found, show a message
        if (alternatives.length === 0) {
            const listEl = document.getElementById('alternativeList');
            listEl.innerHTML = `
                <div class="text-center py-8">
                    <span class="material-symbols-outlined text-6xl text-slate-400 mb-4">location_off</span>
                    <p class="text-gray-600 dark:text-gray-400 text-sm">No alternative carparks available nearby. Please try a different destination.</p>
                </div>
            `;
        } else {
            const listEl = document.getElementById('alternativeList');
            listEl.innerHTML = '';
            
            alternatives.forEach((alt, index) => {
                const availabilityColor = getAvailabilityColor(alt.availableLots, alt.lotCount);
                const colorMap = { emerald: 'green-500', amber: 'amber-500', rose: 'rose-500' };
                const color = colorMap[availabilityColor];
                
                const altCard = document.createElement('div');
                altCard.className = `flex items-center gap-4 ${index === 0 ? 'bg-primary/10 dark:bg-primary/20 border-2 border-primary' : 'bg-gray-100 dark:bg-white/5 border border-transparent'} p-4 rounded-xl transition-all`;
                altCard.innerHTML = `
                    <div class="flex h-12 w-12 shrink-0 items-center justify-center rounded-lg ${index === 0 ? 'bg-primary' : 'bg-gray-300 dark:bg-gray-800'} text-white">
                        <span class="material-symbols-outlined">local_parking</span>
                    </div>
                    <div class="flex flex-1 flex-col justify-center">
                        <div class="flex justify-between items-start">
                            <p class="text-gray-900 dark:text-white text-base font-bold leading-none mb-1">${alt.name}</p>
                            ${index === 0 ? '<span class="text-xs font-bold bg-green-500/20 text-green-500 px-2 py-0.5 rounded-full border border-green-500/30">BEST</span>' : ''}
                        </div>
                        <p class="text-gray-600 dark:text-gray-400 text-xs font-medium">${formatDistance(alt.distance)} away â€¢ <span class="text-${color} font-bold">${alt.availableLots} lots available</span></p>
                    </div>
                    <div class="shrink-0 flex items-center justify-center">
                        ${index === 0 ? '<span class="material-symbols-outlined text-primary fill-1">check_circle</span>' : '<div class="w-5 h-5 rounded-full border-2 border-gray-400 dark:border-gray-600"></div>'}
                    </div>
                `;
                listEl.appendChild(altCard);
            });
        }
        
        modal.classList.remove('hidden');
    }
    
    // Switch route
    document.getElementById('switchRouteBtn').addEventListener('click', function() {
        const alternatives = mockCarparks
            .filter(cp => cp.id !== carparkData.id)
            .slice(0, 1);
        
        if (alternatives.length > 0) {
            sessionStorage.setItem('selectedCarpark', JSON.stringify(alternatives[0]));
            document.getElementById('reRecommendationModal').classList.add('hidden');
            // Update display
            document.getElementById('destinationName').textContent = alternatives[0].name;
        }
    });
    
    // Ignore button
    document.getElementById('ignoreBtn').addEventListener('click', function() {
        document.getElementById('reRecommendationModal').classList.add('hidden');
        // User chooses to continue anyway - stop checking
        if (availabilityCheckInterval) {
            clearInterval(availabilityCheckInterval);
        }
    });
</script>
</body>
</html>
